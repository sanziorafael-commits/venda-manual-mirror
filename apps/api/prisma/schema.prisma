generator client {
  provider   = "prisma-client-js"
  engineType = "binary"
}

datasource db {
  provider = "postgresql"
}

enum UserRole {
  ADMIN
  DIRETOR
  GERENTE_COMERCIAL
  SUPERVISOR
  VENDEDOR
}

enum LocatedClientStatus {
  PENDENTE_VISITA
  VISITADO
}

model Company {
  id                  String                         @id @default(cuid())
  name                String
  cnpj                String                         @unique
  logoUrl             String?
  users               User[]
  locatedClients      LocatedClient[]
  products            produtos[]                     @relation("ProdutoCompany")
  conversationHistory historico_conversas[]          @relation("HistoricoConversaCompany")
  citedProducts       historico_conversas_produtos[] @relation("HistoricoConversaProdutoCompany")
  userDeletionAudits  UserDeletionAudit[]
  deletedAt           DateTime?
  createdAt           DateTime                       @default(now())
  updatedAt           DateTime                       @updatedAt
}

model User {
  id                         String                   @id @default(cuid())
  companyId                  String?
  company                    Company?                 @relation(fields: [companyId], references: [id], onDelete: SetNull)
  managerId                  String?
  manager                    User?                    @relation("ManagerToSupervisor", fields: [managerId], references: [id], onDelete: SetNull)
  managedSupervisors         User[]                   @relation("ManagerToSupervisor")
  supervisorId               String?
  supervisor                 User?                    @relation("SupervisorToVendor", fields: [supervisorId], references: [id], onDelete: SetNull)
  managedVendors             User[]                   @relation("SupervisorToVendor")
  role                       UserRole
  fullName                   String
  cpf                        String                   @unique
  email                      String?                  @unique
  phone                      String
  passwordHash               String?
  isActive                   Boolean                  @default(true)
  deletedAt                  DateTime?
  sessions                   Session[]
  conversationHistory        historico_conversas[]    @relation("HistoricoConversaUser")
  activationTokens           AccountActivationToken[]
  passwordResetTokens        PasswordResetToken[]
  userDeletionAuditsAsTarget UserDeletionAudit[]      @relation("UserDeletionTarget")
  userDeletionAuditsAsActor  UserDeletionAudit[]      @relation("UserDeletionActor")
  identifiedLocatedClients   LocatedClient[]          @relation("LocatedClientIdentifiedBy")
  visitedLocatedClients      LocatedClient[]          @relation("LocatedClientVisitedBy")
  createdAt                  DateTime                 @default(now())
  updatedAt                  DateTime                 @updatedAt

  @@unique([companyId, phone], map: "users_company_phone_key")
  @@index([companyId, role], map: "users_company_role_idx")
  @@index([companyId, managerId], map: "users_company_manager_idx")
  @@index([companyId, supervisorId], map: "users_company_supervisor_idx")
}

model LocatedClient {
  id                 String              @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  companyId          String?             @map("company_id")
  company            Company?            @relation(fields: [companyId], references: [id], onDelete: SetNull)
  identifiedByUserId String?             @map("identified_by_user_id")
  identifiedByUser   User?               @relation("LocatedClientIdentifiedBy", fields: [identifiedByUserId], references: [id], onDelete: SetNull)
  sourceSellerPhone  String              @map("source_seller_phone")
  customerName       String              @map("customer_name")
  city               String
  state              String
  address            String
  mapUrl             String?             @map("map_url")
  identifiedAt       DateTime            @map("identified_at") @db.Timestamptz(6)
  status             LocatedClientStatus @default(PENDENTE_VISITA)
  visitedAt          DateTime?           @map("visited_at") @db.Timestamptz(6)
  visitedByUserId    String?             @map("visited_by_user_id")
  visitedByUser      User?               @relation("LocatedClientVisitedBy", fields: [visitedByUserId], references: [id], onDelete: SetNull)
  deletedAt          DateTime?           @map("deleted_at") @db.Timestamptz(6)
  createdAt          DateTime            @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt          DateTime            @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@index([companyId], map: "idx_located_clients_company_id")
  @@index([identifiedByUserId], map: "idx_located_clients_identified_by_user_id")
  @@index([sourceSellerPhone], map: "idx_located_clients_source_seller_phone")
  @@index([status], map: "idx_located_clients_status")
  @@index([identifiedAt(sort: Desc)], map: "idx_located_clients_identified_at")
  @@index([companyId, identifiedAt(sort: Desc)], map: "idx_located_clients_company_identified_at")
  @@index([visitedByUserId], map: "idx_located_clients_visited_by_user_id")
  @@map("located_clients")
}

model UserDeletionAudit {
  id              String   @id @default(cuid())
  targetUserId    String
  targetUser      User     @relation("UserDeletionTarget", fields: [targetUserId], references: [id], onDelete: Restrict)
  targetCompanyId String?
  targetCompany   Company? @relation(fields: [targetCompanyId], references: [id], onDelete: SetNull)
  actorUserId     String
  actorUser       User     @relation("UserDeletionActor", fields: [actorUserId], references: [id], onDelete: Restrict)
  actorRole       UserRole
  deletedAt       DateTime
  createdAt       DateTime @default(now())

  @@index([targetUserId], map: "user_deletion_audit_target_user_idx")
  @@index([actorUserId], map: "user_deletion_audit_actor_user_idx")
  @@index([targetCompanyId], map: "user_deletion_audit_target_company_idx")
  @@index([deletedAt], map: "user_deletion_audit_deleted_at_idx")
}

model Session {
  id               String    @id @default(cuid())
  userId           String
  user             User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  refreshTokenHash String
  userAgent        String?
  ipAddress        String?
  expiresAt        DateTime
  revokedAt        DateTime?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  @@unique([userId, refreshTokenHash], map: "sessions_user_refresh_hash_key")
  @@index([userId, revokedAt], map: "sessions_user_revoked_idx")
}

model AccountActivationToken {
  id        String    @id @default(cuid())
  userId    String
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  tokenHash String    @unique
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@index([userId, usedAt], map: "activation_tokens_user_used_idx")
  @@index([expiresAt], map: "activation_tokens_expires_idx")
}

model PasswordResetToken {
  id        String    @id @default(cuid())
  userId    String
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  tokenHash String    @unique
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@index([userId, usedAt], map: "password_reset_tokens_user_used_idx")
  @@index([expiresAt], map: "password_reset_tokens_expires_idx")
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model historico_conversas {
  id                String                         @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  created_at        DateTime?                      @default(now()) @db.Timestamptz(6)
  timestamp_iso     DateTime?                      @db.Timestamptz(6)
  user_id           String?
  company_id        String?
  user              User?                          @relation("HistoricoConversaUser", fields: [user_id], references: [id], onDelete: SetNull)
  company           Company?                       @relation("HistoricoConversaCompany", fields: [company_id], references: [id], onDelete: SetNull)
  sender_id         String?
  data              DateTime?                      @db.Date
  msg_type          String?
  flow_name         String?
  execution_id      String?
  message_id        String?
  mensagem          String?
  resposta          String?
  vendedor_nome     String?
  vendedor_telefone String?
  supervisor        String?
  cliente_nome      String?
  leads_encontrados String?
  citedProducts     historico_conversas_produtos[] @relation("HistoricoConversaProdutoHistorico")

  @@index([cliente_nome], map: "idx_historico_cliente")
  @@index([data], map: "idx_historico_data")
  @@index([sender_id], map: "idx_historico_sender")
  @@index([timestamp_iso], map: "idx_historico_timestamp")
  @@index([user_id], map: "idx_historico_user_id")
  @@index([company_id], map: "idx_historico_company_id")
  @@index([vendedor_telefone], map: "idx_historico_vendedor_telefone")
  @@index([company_id, vendedor_telefone], map: "idx_historico_company_phone")
  @@index([vendedor_nome], map: "idx_historico_vendedor")
}

model historico_conversas_produtos {
  id           String              @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  historico_id String              @db.Uuid
  produto_id   String              @db.Uuid
  company_id   String?
  cited_at     DateTime            @default(now()) @db.Timestamptz(6)
  source       String?
  historico    historico_conversas @relation("HistoricoConversaProdutoHistorico", fields: [historico_id], references: [id], onDelete: Cascade)
  produto      produtos            @relation("HistoricoConversaProdutoProduto", fields: [produto_id], references: [id], onDelete: Cascade)
  company      Company?            @relation("HistoricoConversaProdutoCompany", fields: [company_id], references: [id], onDelete: SetNull)

  @@unique([historico_id, produto_id], map: "historico_conversas_produtos_historico_produto_key")
  @@index([historico_id], map: "idx_historico_produtos_historico_id")
  @@index([produto_id], map: "idx_historico_produtos_produto_id")
  @@index([company_id], map: "idx_historico_produtos_company_id")
  @@index([company_id, produto_id], map: "idx_historico_produtos_company_produto")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model produtos {
  id                                  String                         @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  created_at                          DateTime                       @default(now()) @db.Timestamptz(6)
  updated_at                          DateTime                       @default(now()) @db.Timestamptz(6)
  company_id                          String?
  company                             Company?                       @relation("ProdutoCompany", fields: [company_id], references: [id], onDelete: SetNull)
  nome                                String
  descricao_comercial                 String?
  codigo_interno_sku                  String?
  marca                               String?
  categorias                          String[]                       @default([])
  categoria_outro                     String?
  tipologias_clientes                 String[]                       @default([])
  tipologia_cliente_outro             String?
  sugestoes_receitas                  String?
  codigo_barras_ean                   String?
  codigo_barras_dun                   String?
  codigo_fiscal_ncm                   String?
  tipo_conservacao                    String?
  tipo_conservacao_outro              String?
  validade_embalagem_fechada          String?
  validade_apos_abertura              String?
  validade_apos_preparo               String?
  instrucoes_conservacao_produto      String?
  restricoes_produto                  String?
  unidade_venda                       String?
  unidade_venda_outro                 String?
  peso_liquido_volume                 String?
  peso_bruto                          String?
  qtd_unidades_por_caixa              String?
  instrucoes_conservacao_embalagem    String?
  restricoes_embalagem                String?
  possui_ingredientes                 Boolean?
  ingredientes                        String?
  alergenos                           String?
  produto_pronto_uso                  String?
  produto_pronto_uso_outro            String?
  modo_preparo                        String?
  observacoes_uso                     String?
  objecoes_argumentacoes              Json?                          @default("[]")
  fotos_produto                       String[]                       @default([])
  videos_material                     String[]                       @default([])
  observacoes_imagens                 String?
  informacoes_tecnicas_complementares String?
  certificacoes_registros             String?
  observacoes_comerciais              String?
  diferenciais_produto                String?
  observacoes_gerais                  String?
  citedOnHistory                      historico_conversas_produtos[] @relation("HistoricoConversaProdutoProduto")

  @@index([company_id], map: "idx_produtos_company_id")
  @@index([company_id, nome], map: "idx_produtos_company_nome")
  @@index([codigo_interno_sku], map: "idx_produtos_codigo_interno")
  @@index([created_at(sort: Desc)], map: "idx_produtos_created_at")
  @@index([marca], map: "idx_produtos_marca")
  @@index([nome], map: "idx_produtos_nome")
  @@index([objecoes_argumentacoes], map: "idx_produtos_objecoes", type: Gin)
}
